<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>etihadmenu.uz — Кабинет (корпоративный)</title>
<style>
  :root{
    --dark-bg: #0f2f23;
    --brand-green: #165a3c;
    --brand-gold: #a67c28;
    --card:#ffffff;
    --muted: #9fb1a4;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(180deg,var(--dark-bg), #0b241d);
    color:#eef6ef;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:28px;
  }
  .frame{
    width:100%;
    max-width:1100px;
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    border-radius:14px;
    padding:18px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.6);
    border: 1px solid rgba(255,255,255,0.03);
    color: #f2fbf4;
  }

  .brand{display:flex;gap:14px;align-items:center}
  .logo{
    width:56px;height:56px;border-radius:10px;
    background:linear-gradient(135deg,var(--brand-green), #0f6f4d);
    display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--card);
    box-shadow:0 8px 18px rgba(0,0,0,0.5);
    font-size:20px;
  }
  h1{margin:0;font-size:20px}
  .subtitle{color:var(--muted);font-size:13px;margin-top:4px}

  .card{
    margin-top:16px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;
    padding:14px;
    border: 1px solid rgba(255,255,255,0.03);
  }

  input,select,button{font-family:inherit}
  input,select{
    padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);
    background: rgba(255,255,255,0.02); color: #e9f9ec; outline:none;
  }
  input::placeholder{color: rgba(255,255,255,0.35)}
  .actions{display:flex;gap:8px;align-items:center}

  button{
    background: var(--brand-green);
    color:#fff;padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;
    box-shadow: 0 6px 18px rgba(22,90,60,0.14);
  }
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#e6f6ea;padding:8px;border-radius:10px}

  .sessions-area{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .sess-card{
    width:260px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.03); box-shadow:0 12px 30px rgba(0,0,0,0.45); cursor:pointer; display:flex;flex-direction:column;gap:8px;
  }
  .sess-card.active{outline:3px solid rgba(166,124,40,0.12);transform:translateY(-6px)}
  .sess-card.waiting{opacity:0.98;border-style:dashed;border-color:rgba(255,255,255,0.02)}
  .sess-title{font-weight:800;color:var(--brand-gold);font-size:16px}
  .sess-meta{font-size:13px;color:var(--muted)}
  .sess-items{font-size:13px;color:#e6f6ea;min-height:34px}

  .sess-controls{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
  label{cursor:pointer}
  .menu-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-top:12px}
  .menu-item{
    padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.03); text-align:center; font-weight:700; color:#f6fff6; cursor:pointer;
  }
  .menu-item small{display:block;color:var(--muted);font-weight:600;margin-top:6px}

  .note{font-size:13px;color:var(--muted);margin-top:8px}

  table{width:100%;border-collapse:collapse;margin-top:10px;color:#eaf7ec}
  th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px}
  th{color:var(--muted);font-weight:700}
  .clear-link{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--brand-gold);padding:6px 10px;border-radius:8px;cursor:pointer}

  @media(max-width:980px){ .sess-card{width:calc(50% - 12px)} }
  @media(max-width:560px){ .sess-card{width:100%} .frame{padding:10px} .menu-grid{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body>
  <div class="frame" id="app">
    <div class="brand">
      <div class="logo">ET</div>
      <div>
        <h1>etihadmenu.uz — Кабинет</h1>
        <div class="subtitle">Корпоративный интерфейс — кофеледи и кабинет директора</div>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <div style="font-weight:800">Войти</div>
      <div class="note" style="margin-top:6px">Введите логин и пароль (есть демо-кнопка для Одины)</div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <input id="loginInput" placeholder="Логин (напр. odina)" autocomplete="username" style="flex:1;min-width:160px">
        <input id="passInput" type="password" placeholder="Пароль" autocomplete="current-password" style="width:160px">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="loginBtn">Войти</button>
          <button id="demoBtn" class="btn-ghost">Демо: Одина</button>
        </div>
      </div>
      <div id="loginError" class="note" style="color:#ffb3a3;display:none;margin-top:8px"></div>
    </div>

    <!-- MAIN (бариста) -->
    <div id="mainView" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div>
            <div style="font-weight:800" id="whoName">Одина</div>
            <div class="note">Можно вести несколько клиентов одновременно; поддерживается ожидание</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="newSessManager"></select>
            <button id="newSessBtn">Новая сессия</button>
          </div>
        </div>

        <div class="note">Нажми карточку сессии чтобы выбрать её (выделится). Меню добавляет позицию в выбранную карточку. Если у менеджера уже есть активная — новая будет в статусе Ожидание.</div>

        <div class="sessions-area" id="sessionsArea"></div>

        <div class="menu-grid" id="menuGrid"></div>
      </div>

      <div class="card">
        <h3 style="margin:0">Последние сессии</h3>
        <div id="recentLog" class="note" style="margin-top:8px">Пока пусто</div>
        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <button id="resetBtn" class="clear-link">Сбросить все сессии</button>
          <div class="note" style="margin:0">Начать с чистого хранилища (localStorage)</div>
        </div>
      </div>
    </div>

    <!-- DIRECTOR -->
    <div id="directorView" style="display:none" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:800">Кабинет директора</div>
          <div class="note">Отчёты по сотрудникам</div>
        </div>
        <div><select id="filterUser"><option value="">Все</option></select></div>
      </div>
      <div id="directorTables"></div>
    </div>
  </div>

<script>
/* ---------------- State & Defaults ---------------- */
const STORAGE_KEY = 'etihad_custom_v1';
const DEFAULT = {
  users:[
    {id:'od1',login:'odina',password:'1234',name:'Одина',role:'barista'},
    {id:'m_abd',login:'abdulloh',password:'1111',name:'Абдуллох',role:'manager'},
    {id:'m_amr',login:'amr',password:'2222',name:'Амр',role:'manager'},
    {id:'m_mub',login:'mubina',password:'3333',name:'Мубина',role:'manager'},
    {id:'m_sh',login:'shahnоza',password:'4444',name:'Шахноза',role:'manager'},
    {id:'dir1',login:'khurshid',password:'0000',name:'Хуршид',role:'director'}
  ],
  menu:[
    {id:'c1',title:'Чёрный чай',cat:'Чай'},
    {id:'c2',title:'Зелёный чай',cat:'Чай'},
    {id:'c3',title:'Эспрессо',cat:'Кофе'},
    {id:'c4',title:'Капучино',cat:'Кофе'},
    {id:'c5',title:'Апельсиновый сок',cat:'Соки'}
  ],
  sessions: []
};

function loadRaw(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch(e){ return null; }
}
function saveState(st){ localStorage.setItem(STORAGE_KEY, JSON.stringify(st)); }
function now(){ return Date.now(); }

// Load + migration
function load(){
  let raw = loadRaw();
  if(!raw){
    saveState(DEFAULT);
    return JSON.parse(JSON.stringify(DEFAULT));
  }
  // ensure arrays
  raw.sessions = Array.isArray(raw.sessions) ? raw.sessions : [];
  raw.menu = Array.isArray(raw.menu) ? raw.menu : (DEFAULT.menu.slice());
  raw.users = Array.isArray(raw.users) ? raw.users : (DEFAULT.users.slice());

  // validate sessions: ensure fields exist
  raw.sessions = raw.sessions.map(s=>{
    s = s || {};
    s.sid = s.sid || ('s'+(Date.now()+Math.floor(Math.random()*999)));
    s.userId = s.userId || 'od1';
    s.managerId = s.managerId || s.manager || '';
    s.createdAt = s.createdAt || s.created || (Date.now());
    s.started = s.started || null;
    s.ended = s.ended || null;
    s.waitedSeconds = typeof s.waitedSeconds === 'number' ? s.waitedSeconds : 0;
    s.duration = typeof s.duration === 'number' ? s.duration : (s.ended && s.started ? Math.round((s.ended - s.started)/1000) : null);
    s.status = s.status || (s.ended ? 'finished' : (s.started ? 'active' : 'waiting'));
    s.items = Array.isArray(s.items) ? s.items : (s.items ? [s.items] : []);
    s.readyToFinish = !!s.readyToFinish;
    return s;
  });

  // normalize manager sessions: ensure exactly 0 or 1 active per manager
  const managers = [...new Set(raw.sessions.map(x=>x.managerId).filter(Boolean))];
  managers.forEach(mid=>{
    const list = raw.sessions.filter(s=>s.managerId===mid && s.status!=='finished').sort((a,b)=> (a.createdAt||0) - (b.createdAt||0));
    const hasActive = list.some(s=>s.status==='active');
    if(!hasActive && list.length) {
      // oldest becomes active
      list[0].status = 'active';
      list[0].started = list[0].started || list[0].createdAt;
    }
    // others must be waiting
    list.forEach((s,idx)=>{ if(s.status!=='finished' && s.status!=='active') s.status='waiting'; });
  });

  saveState(raw);
  return raw;
}

let state = load();
let currentUser = null;
let selectedSessionId = null;
let timers = {};
let lastNewAt = 0;

/* ---------------- Refs ---------------- */
const loginCard = document.getElementById('loginCard');
const mainView = document.getElementById('mainView');
const directorView = document.getElementById('directorView');
const loginInput = document.getElementById('loginInput');
const passInput = document.getElementById('passInput');
const loginBtn = document.getElementById('loginBtn');
const demoBtn = document.getElementById('demoBtn');
const loginError = document.getElementById('loginError');

const whoName = document.getElementById('whoName');
const newSessManager = document.getElementById('newSessManager');
const newSessBtn = document.getElementById('newSessBtn');
const sessionsArea = document.getElementById('sessionsArea');
const menuGrid = document.getElementById('menuGrid');
const recentLog = document.getElementById('recentLog');

const filterUser = document.getElementById('filterUser');
const directorTables = document.getElementById('directorTables');
const resetBtn = document.getElementById('resetBtn');

/* ---------------- Helpers ---------------- */
function findUserByLogin(l,p){ return state.users.find(u=>String(u.login||'').trim().toLowerCase()===String(l||'').trim().toLowerCase() && String(u.password||'')===String(p||'')); }
function findUserById(id){ return state.users.find(u=>u.id===id) || {name: id || '—'}; }
function formatDur(sec){ const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; if(h>0) return `${h}ч ${m}м ${s}с`; return `${m}м ${s}с`; }

/* ---------------- Render ---------------- */
function renderMenu(){
  menuGrid.innerHTML = '';
  state.menu.forEach(it=>{
    const el = document.createElement('div'); el.className='menu-item'; el.dataset.id = it.id;
    el.innerHTML = `<div>${it.title}</div><small>${it.cat}</small>`;
    menuGrid.appendChild(el);
  });
}
function renderManagersList(){
  newSessManager.innerHTML = '';
  state.users.filter(u=>u.role==='manager').forEach(m=>{
    const o = document.createElement('option'); o.value = m.id; o.textContent = m.name; newSessManager.appendChild(o);
  });
  filterUser.innerHTML = '<option value="">Все</option>';
  state.users.forEach(u=>{ const opt=document.createElement('option'); opt.value=u.id; opt.textContent = `${u.name} — ${u.role}`; filterUser.appendChild(opt); });
}

function clearTimers(){
  Object.keys(timers).forEach(k=>{
    clearInterval(timers[k]); delete timers[k];
  });
}

function renderSessions(){
  clearTimers();
  sessionsArea.innerHTML = '';
  const active = state.sessions.filter(s=>s.status==='active');
  const waiting = state.sessions.filter(s=>s.status==='waiting');
  const finished = state.sessions.filter(s=>s.status==='finished').slice(-8).reverse();
  const list = [...active, ...waiting, ...finished];
  list.forEach(s => sessionsArea.appendChild(createSessionCard(s)));
}

function createSessionCard(s){
  const card = document.createElement('div');
  card.className = 'sess-card' + (selectedSessionId===s.sid && s.status==='active' ? ' active' : '') + (s.status==='waiting' ? ' waiting' : '');
  card.dataset.sid = s.sid;
  const userName = findUserById(s.userId).name;
  const managerName = findUserById(s.managerId).name || '—';
  const createdLabel = s.createdAt ? new Date(s.createdAt).toLocaleTimeString() : '-';
  const statusLabel = s.status === 'waiting' ? 'Ожидание' : (s.status==='active' ? 'В обслуживании' : 'Завершено');

  card.innerHTML = `<div class="sess-title">${userName}</div><div class="sess-meta">${managerName} · ${statusLabel} · ${createdLabel}</div>`;

  const items = document.createElement('div'); items.className='sess-items';
  items.textContent = (s.items || []).map(it=>it.title).join(', ') || '(пусто)';
  card.appendChild(items);

  const ctr = document.createElement('div'); ctr.className='sess-controls';

  if(s.status === 'waiting'){
    const waitedSec = s.createdAt ? Math.round((now() - s.createdAt)/1000) : 0;
    const waitedEl = document.createElement('div'); waitedEl.className='sess-meta'; waitedEl.style.fontWeight='700'; waitedEl.style.marginRight='6px';
    waitedEl.textContent = 'Ждет: ' + formatDur(waitedSec);
    ctr.appendChild(waitedEl);

    const startBtn = document.createElement('button'); startBtn.textContent = 'Начать обслуживание'; startBtn.style.padding='6px 8px'; startBtn.style.fontSize='13px';
    startBtn.addEventListener('click', ev => { ev.stopPropagation(); startServiceForSession(s.sid); });
    ctr.appendChild(startBtn);

    // live update waiting time
    timers[s.sid] = setInterval(()=>{
      const elMeta = card.querySelector('.sess-meta');
      if(elMeta){
        const waitedNow = s.createdAt ? Math.round((now() - s.createdAt)/1000) : 0;
        elMeta.textContent = `${managerName} · ${statusLabel} · ${createdLabel} · Ждет ${formatDur(waitedNow)}`;
      }
    }, 1000);

  } else if(s.status === 'active'){
    const chkWrap = document.createElement('label');
    chkWrap.style.display='flex'; chkWrap.style.alignItems='center'; chkWrap.style.gap='8px'; chkWrap.style.fontSize='13px';
    const input = document.createElement('input'); input.type='checkbox'; input.dataset.sid = s.sid;
    input.title = 'Поставьте галочку если стол очищен';
    input.addEventListener('click', e => e.stopPropagation());
    input.checked = !!s.readyToFinish;
    const span = document.createElement('span'); span.textContent = 'Стол очищен';
    chkWrap.appendChild(input); chkWrap.appendChild(span);
    ctr.appendChild(chkWrap);

    const finishBtn = document.createElement('button'); finishBtn.textContent = 'Завершить'; finishBtn.style.padding='6px 8px'; finishBtn.style.fontSize='13px';
    finishBtn.disabled = !input.checked;
    finishBtn.addEventListener('click', ev => { ev.stopPropagation(); finishSessionWithCheck(s.sid); });
    ctr.appendChild(finishBtn);

    const timerEl = document.createElement('div'); timerEl.className='sess-meta'; timerEl.style.fontWeight='700'; timerEl.style.marginLeft='6px';
    ctr.appendChild(timerEl);

    input.addEventListener('change', ev=>{
      const checked = !!ev.target.checked;
      const ss = state.sessions.find(x=>x.sid===s.sid);
      if(ss){ ss.readyToFinish = checked; saveState(state); }
      finishBtn.disabled = !checked;
    });

    // update active timer: show manager · startedTime · elapsed
    function updateActiveTimer(){
      const ss = state.sessions.find(x=>x.sid===s.sid);
      if(!ss || ss.status !== 'active'){ if(timers[s.sid]){ clearInterval(timers[s.sid]); delete timers[s.sid]; } return; }
      const tEl = timerEl;
      const timeLabel = ss.started ? new Date(ss.started).toLocaleTimeString() : (ss.createdAt ? new Date(ss.createdAt).toLocaleTimeString() : '-');
      const elapsed = ss.started ? formatDur(Math.round((Date.now() - ss.started)/1000)) : '-';
      tEl.textContent = `${managerName} · ${timeLabel} · ${elapsed}`;
    }
    updateActiveTimer();
    timers[s.sid] = setInterval(updateActiveTimer, 1000);

  } else { // finished
    const endedAt = s.ended ? new Date(s.ended).toLocaleTimeString() : '-';
    const dur = s.duration ? formatDur(s.duration) : '-';
    const waited = s.waitedSeconds ? formatDur(s.waitedSeconds) : '-';
    const footer = document.createElement('div'); footer.className='sess-meta'; footer.innerHTML = `Завершено: ${endedAt} · ${dur} · Ожидал: ${waited}`;
    ctr.appendChild(footer);
  }

  card.appendChild(ctr);

  if(s.status !== 'finished'){
    card.addEventListener('click', ()=>{
      selectedSessionId = s.sid;
      renderSessions();
    });
  }

  return card;
}

/* ---------------- Session flow ---------------- */
function startNewSession(managerId){
  if(Date.now() - lastNewAt < 700) return; // prevent double
  lastNewAt = Date.now();
  if(!currentUser) return alert('Не авторизован');
  if(!managerId) return alert('Выберите менеджера');
  const hasActive = state.sessions.some(x=>x.managerId===managerId && x.status==='active');
  const sid = 's'+(Date.now()+Math.floor(Math.random()*999));
  const nowTs = now();
  const status = hasActive ? 'waiting' : 'active';
  const s = { sid, userId: currentUser.id, managerId, createdAt: nowTs, started: status==='active' ? nowTs : null, waitedSeconds: 0, ended: null, duration: null, status, items: [], readyToFinish:false };
  state.sessions.push(s); saveState(state);
  if(status === 'active') selectedSessionId = sid;
  renderSessions(); renderRecentLog(); renderDirectorTables();
}

function startServiceForSession(sid){
  const s = state.sessions.find(x=>x.sid===sid); if(!s) return;
  if(s.status !== 'waiting') return;
  s.started = now();
  s.waitedSeconds = Math.round((s.started - (s.createdAt || s.started))/1000);
  s.status = 'active';
  saveState(state);
  selectedSessionId = sid;
  renderSessions(); renderRecentLog(); renderDirectorTables();
}

function finishSessionWithCheck(sid){
  const s = state.sessions.find(x=>x.sid===sid); if(!s) return;
  if(!s.readyToFinish) return alert('Поставьте галочку "Стол очищен", чтобы завершить сессию');
  finishSession(sid);
}

function finishSession(sid){
  const s = state.sessions.find(x=>x.sid===sid); if(!s) return;
  if(!s.ended){
    s.ended = now();
    s.duration = Math.round((s.ended - (s.started || s.createdAt))/1000);
    if(!s.waitedSeconds && s.started && s.createdAt) s.waitedSeconds = Math.round((s.started - s.createdAt)/1000);
    s.status = 'finished';
    saveState(state);
  }
  if(selectedSessionId === sid) selectedSessionId = null;
  renderSessions(); renderRecentLog(); renderDirectorTables();
}

/* ---------------- Add item ---------------- */
function addItemToSession(itemId){
  const item = state.menu.find(m=>m.id===itemId); if(!item) return;
  let target = state.sessions.find(s=>s.sid===selectedSessionId && s.status!=='finished');
  if(!target){
    const actives = state.sessions.filter(s=>s.status==='active');
    target = actives.length ? actives[actives.length-1] : null;
  }
  if(!target){
    const waitings = state.sessions.filter(s=>s.status==='waiting');
    target = waitings.length ? waitings[waitings.length-1] : null;
  }
  if(!target) { alert('Нет открытой сессии. Создайте новую сессию.'); return; }
  target.items.push({ title: item.title, at: now() });
  saveState(state);
  renderSessions(); renderRecentLog(); renderDirectorTables();
}

/* ---------------- Logs / Director ---------------- */
function renderRecentLog(){
  const rows = state.sessions.slice().reverse().slice(0,8);
  if(!rows.length){ recentLog.textContent='Пока пусто'; return; }
  let html = '<table><thead><tr><th>Сотрудник</th><th>Менеджер</th><th>Время</th><th>Статус</th><th>Позиции</th></tr></thead><tbody>';
  rows.forEach(s=>{
    const u = findUserById(s.userId).name;
    const m = findUserById(s.managerId).name || '-';
    const t = s.createdAt ? new Date(s.createdAt).toLocaleString() : '-';
    const items = (s.items||[]).map(it=>it.title).join(', ') || '-';
    const st = s.status || '-';
    html += `<tr><td>${u}</td><td>${m}</td><td>${t}</td><td>${st}</td><td>${items}</td></tr>`;
  });
  html += '</tbody></table>';
  recentLog.innerHTML = html;
}

function renderDirectorTables(){
  const f = filterUser.value;
  const rows = state.sessions.slice().reverse().filter(s=> !f || s.userId===f);
  let html = '<div style="overflow:auto"><table><thead><tr><th>Сотрудник</th><th>Менеджер</th><th>Начало</th><th>Завершение</th><th>Длительность</th><th>Ожидание</th><th>В ожидании</th><th>Во время обслуживания</th></tr></thead><tbody>';
  rows.forEach(s=>{
    const u = findUserById(s.userId).name;
    const m = findUserById(s.managerId).name || '-';
    const start = s.started ? new Date(s.started).toLocaleString() : (s.createdAt ? 'ожидал' : '-');
    const end = s.ended ? new Date(s.ended).toLocaleString() : (s.started ? 'активна' : '-');
    const dur = s.duration ? formatDur(s.duration) : (s.started ? formatDur(Math.round((now()-s.started)/1000)) : '-');
    const waited = s.waitedSeconds ? formatDur(s.waitedSeconds) : '-';
    const waitingItems = [], servingItems = [];
    (s.items||[]).forEach(it=>{ if(s.started && it.at >= s.started) servingItems.push(it.title); else waitingItems.push(it.title); });
    const w = waitingItems.length ? waitingItems.join('; ') : '-';
    const sv = servingItems.length ? servingItems.join('; ') : '-';
    html += `<tr><td>${u}</td><td>${m}</td><td>${start}</td><td>${end}</td><td>${dur}</td><td>${waited}</td><td>${w}</td><td>${sv}</td></tr>`;
  });
  html += '</tbody></table></div>';
  directorTables.innerHTML = html;
}

/* ---------------- Events ---------------- */
loginBtn.addEventListener('click', ()=>{
  const l = String(loginInput.value||'').trim().toLowerCase();
  const p = String(passInput.value||'');
  if(!l || !p){ loginError.style.display='block'; loginError.textContent='Введите логин и пароль'; return; }
  const user = findUserByLogin(l,p);
  if(!user){ loginError.style.display='block'; loginError.textContent='Неверный логин или пароль'; return; }
  loginError.style.display='none';
  currentUser = user;
  if(user.role === 'barista'){
    loginCard.style.display='none'; mainView.style.display='block'; directorView.style.display='none';
    whoName.textContent = user.name;
    renderManagersList(); renderMenu(); renderSessions(); renderRecentLog();
  } else if(user.role === 'director'){
    loginCard.style.display='none'; mainView.style.display='none'; directorView.style.display='block';
    renderManagersList(); renderDirectorTables();
  } else {
    alert('Поддерживаются кабинеты: кофеледи и директор. Войдите соответствующим пользователем.');
  }
});
demoBtn.addEventListener('click', ()=>{ const u = state.users.find(x=>x.login==='odina'); if(u){ loginInput.value='odina'; passInput.value='1234'; loginBtn.click(); } });

newSessBtn.addEventListener('click', ()=>{ const m = newSessManager.value; if(!m) return alert('Выберите менеджера'); startNewSession(m); });
menuGrid.addEventListener('click', (e)=>{ const el = e.target.closest('.menu-item'); if(!el) return; addItemToSession(el.dataset.id); });
filterUser.addEventListener('change', ()=> renderDirectorTables());
resetBtn.addEventListener('click', ()=>{ if(!confirm('Сбросить все сессии и начать с нуля?')) return; state.sessions = []; saveState(state); renderSessions(); renderRecentLog(); renderDirectorTables(); });

/* ---------------- Init ---------------- */
renderManagersList(); renderMenu(); renderRecentLog();
console.log('etihadmenu app ready — users:', state.users.map(u=>({login:u.login,role:u.role})));
</script>
</body>
</html>
